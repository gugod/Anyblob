#!/usr/bin/env perl
use 5.012;
use strict;
use warnings;
use FindBin;
use lib "$FindBin::Bin/../lib";
use File::Basename;

use Anyblob::Client;

use JSON qw(to_json);
use Getopt::Long;

my $USAGE = "Usage: @{[ basename($0) ]} -s <server-url> <file>\n";
my $server;
GetOptions("s|server=s" => \$server) or die "Unreconized command line arguments.";

die $USAGE unless $server;
my $client = Anyblob::Client->new(server => $server);

my $file   = shift @ARGV or die "Usage: @{[ basename($0) ]} <file>\n";

my @refs = $client->upload($file);

unless (@refs) {
    die "Error uploading $file";
}

{
    ## Creating receipts
    my $file_basename = basename($file);
    my $receipt = "${file_basename}.json";

    open my $fh, ">:bytes", $receipt;

    say $fh to_json({
        name => $file_basename,
        refs => \@refs
    });

    close $fh;

    say "Stored. Keep the receipt for future retrieving:\n\n    $receipt\n";
}

