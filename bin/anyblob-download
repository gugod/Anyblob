#!/usr/bin/env perl
use 5.012;
use strict;
use warnings;
use FindBin;
use lib "$FindBin::Bin/../lib";
use File::Basename;
use JSON qw(from_json);
use IO::All;
use Anyblob::Client;
use Getopt::Long;

my $USAGE = "Usage: @{[ basename($0) ]} -s <server-url> <receipt.json>\n";
my $server;
GetOptions("s|server=s" => \$server) or die "Unreconized command line arguments.";

die $USAGE unless $server;

my $client = Anyblob::Client->new(server => $server);

my $receipt_file = shift @ARGV or die $USAGE;
my $receipt = from_json( io($receipt_file)->all );

unless( $receipt->{name} && ref($receipt->{refs}) eq 'ARRAY') {
    die "Invalid receipt file.\n";
}

if (-f $receipt->{name}) {
    die "File $receipt->{name} already exists.\n";
}

unless ($client->download( $receipt->{name}, $receipt->{refs} )) {
    die "Failed to download file $receipt->{name}\n";
}

say "\n" . $receipt->{name} . " retrieved\n";
